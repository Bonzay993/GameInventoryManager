<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Edit Game</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
</head>
<body>
  <h1>Edit Game</h1>

  <div class="edit-container">
    {% if game.image_url %}
      <img src="{{ game.image_url }}" alt="Game Image" style="grid-column: 1 / -1; max-width: 100%; border-radius: 10px; margin-bottom: 20px;">
    {% else %}
      <p style="grid-column: 1 / -1; text-align: center; font-style: italic; color: var(--error); margin-bottom: 20px;">
        No image URL provided.
      </p>
    {% endif %}

    <!-- Edit form with id and proper button -->
    <form id="edit-form" method="POST" style="grid-column: 1 / -1;">
      <label for="name">Game Name:</label>
      <input id="name" type="text" name="name" value="{{ game.name }}" required>

      <label for="platform">Platform:</label>
      <select id="platform" name="platform" required>
        {% for p in ['PS1', 'PS2', 'PS3', 'PS4', 'PS5', 'OG XBOX', 'XBOX 360', 'XBOX ONE', 'SERIES S', 'SERIES X', 'Nintendo Switch', 'PSP'] %}
          <option value="{{ p }}" {% if game.platform.lower() == p.lower() %}selected{% endif %}>{{ p }}</option>
        {% endfor %}
      </select>

      <label for="image_url">Image URL:</label>
      <input id="image_url" type="text" name="image_url" value="{{ game.image_url }}">

      
      
    </form>

    <!-- Replaced form with a button for JS-driven delete -->
    <div class="button-row">
      <button id="save-btn" class="save-btn">Save Changes</button>
      <button id="delete-btn" class="delete-btn">Delete</button>
    </div>
   <div class="back-btn-container">
      <a href="{{ url_for('index') }}">
        <button class="back-btn" type="button">⬅️ Back to Inventory</button>
      </a>
    </div>
  </div>

  <!-- Confirm save toast -->
  <div id="confirm-save-toast" class="confirm-toast" style="display:none; position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: #222; color: #fff; padding: 20px; border-radius: 10px; box-shadow: 0 0 10px #00ffcc; z-index: 9999; flex-direction: column; align-items: center; gap: 10px;">
    <p>Are you sure you want to save changes?</p>
    <div style="display: flex; gap: 15px;">
      <button id="confirm-save-yes" style="background:#00ffcc; border:none; padding:10px 20px; border-radius:8px; cursor:pointer; color:#000;">Yes</button>
      <button id="confirm-save-no" style="background:#555; border:none; padding:10px 20px; border-radius:8px; cursor:pointer; color:#fff;">No</button>
    </div>
  </div>

  <!-- Confirm delete toast -->
  <div id="confirm-toast" class="confirm-toast" style="display:none; position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%); background: #222; color: #fff; padding: 20px; border-radius: 10px; box-shadow: 0 0 10px #ff4d4d; z-index: 9999; flex-direction: column; align-items: center; gap: 10px;">
    <p>Are you sure you want to delete this game?</p>
    <div style="display: flex; gap: 15px;">
      <button id="confirm-yes" style="background:#ff4d4d; border:none; padding:10px 20px; border-radius:8px; cursor:pointer; color:#fff;">Yes</button>
      <button id="confirm-no" style="background:#555; border:none; padding:10px 20px; border-radius:8px; cursor:pointer; color:#fff;">No</button>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const deleteBtn = document.getElementById('delete-btn');
      const confirmToast = document.getElementById('confirm-toast');
      const confirmYesBtn = document.getElementById('confirm-yes');
      const confirmNoBtn = document.getElementById('confirm-no');

      // Utility toast function for messages
      function showToast(message, type = 'success', duration = 3000) {
        let toast = document.getElementById('page-toast');
        if (!toast) {
          toast = document.createElement('div');
          toast.id = 'page-toast';
          toast.style = `
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            background: ${type === 'error' ? '#ff4d4d' : '#00cc44'};
            color: #fff; padding: 15px 25px; border-radius: 8px;
            box-shadow: 0 0 10px ${type === 'error' ? '#ff1a1a' : '#00ff55'};
            z-index: 10000;
            font-weight: bold;
            user-select: none;
          `;
          document.body.appendChild(toast);
        }
        toast.textContent = message;
        toast.style.background = type === 'error' ? '#ff4d4d' : '#00cc44';
        toast.style.boxShadow = type === 'error' ? '0 0 10px #ff1a1a' : '0 0 10px #00ff55';
        toast.style.display = 'block';
        clearTimeout(toast.hideTimeout);
        toast.hideTimeout = setTimeout(() => {
          toast.style.display = 'none';
        }, duration);
      }

      // Show confirm delete toast
      function showConfirmDelete() {
        confirmToast.style.display = 'flex';
        confirmToast.classList.add('show');
      }

      // Hide confirm delete toast
      function hideConfirmDelete() {
        confirmToast.classList.remove('show');
        confirmToast.style.display = 'none';
      }

      // Delete button click handler
      deleteBtn.addEventListener('click', () => {
        showConfirmDelete();
      });

      // Cancel deletion
      confirmNoBtn.addEventListener('click', () => {
        hideConfirmDelete();
      });

      // Confirm deletion
      confirmYesBtn.addEventListener('click', async () => {
        const userCode = prompt('Enter deletion code to confirm:');
        if (!userCode) {
          showToast('Deletion code is required.', 'error');
          return;
        }

        // Disable buttons while deleting
        confirmYesBtn.disabled = true;
        confirmNoBtn.disabled = true;

        try {
          const res = await fetch(`/delete/{{ game._id }}`, {
            method: 'DELETE',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({ deletion_code: userCode }),
          });

          if (res.ok) {
            showToast('Game deleted.', 'success');
            hideConfirmDelete();
            // Redirect back to inventory after a short delay
            setTimeout(() => {
              window.location.href = "{{ url_for('index') }}";
            }, 1500);
          } else {
            const errorData = await res.json();
            showToast(errorData.message || 'Failed to delete game.', 'error');
          }
        } catch (e) {
          showToast('Error deleting game.', 'error');
        } finally {
          confirmYesBtn.disabled = false;
          confirmNoBtn.disabled = false;
        }
      });
    });
  </script>

  <script src="{{ url_for('static', filename='scripts/script.js') }}"></script>
</body>
</html>
